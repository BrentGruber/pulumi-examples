name: Build vpc infrastructure

on:
    pull_request:
        branches: [main]
        paths:
            - 'tools/vpc/*'
    push:
        branches: [main]
        paths:
            - 'tools/vpc/*'
    

jobs:
    build:
        name: Build vpc infrastructure
        runs-on: [self-hosted, pulumi]
    
        steps:
            - name: Checkout
              uses: actions/checkout@v2
              with:
                path: ${{ env.SRC_PREFIX }}

              # It seems that the runner does not load .bashrc, duh
              # so if we need to use an executable, we need absolute path
            - name: Pulumi build
              env:
                PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
              run: |
                cd tools/vpc
                aws sts get-caller-identity
                aws sts assume-role --role-arn arn:aws:iam::593393184947:role/olufi-role-c30292b --role-session-name olufi-runner
                /.pulumi/bin/pulumi stack select BOM-DEMO/vpc/dev
                npm install
                /.pulumi/bin/pulumi up -y